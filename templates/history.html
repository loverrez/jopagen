{% extends "base.html" %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-12">
    
    <div class="text-center mb-10">
        <h1 class="text-3xl font-bold text-white mb-2">ประวัติการทำรายการ</h1>
        <p class="text-slate-400">ตรวจสอบสถานะการสั่งซื้อและการเติมเงินย้อนหลัง</p>
    </div>

    <div class="glass rounded-2xl shadow-xl border border-slate-700 overflow-hidden">
        <div class="p-6 border-b border-slate-700 flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-lg text-white"><i class="fa-solid fa-box"></i></div>
            <h2 class="text-xl font-bold text-white">ประวัติการสั่งซื้อสินค้า</h2>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full text-left text-slate-300">
                <thead class="bg-slate-900/50 text-slate-400 uppercase text-xs tracking-wider">
                    <tr>
                        <th class="p-4 font-medium">สินค้า</th>
                        <th class="p-4 font-medium">ราคา</th>
                        <th class="p-4 font-medium">วันที่-เวลา</th>
                        <th class="p-4 font-medium text-right">ข้อมูลสินค้า</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-700/50">
                    {% for o in orders %}
                    <tr class="hover:bg-slate-700/50 transition">
                        <td class="p-4">
                            <div class="font-bold text-white">{{ o.category_name }}</div>
                            <div class="text-xs text-slate-500">จำนวน: {{ o.data.split('\n') | length if o.data else 0 }} ชิ้น</div> 
                        </td>
                        <td class="p-4 text-green-400 font-mono font-bold">฿{{ "{:.2f}".format(o.price) }}</td>
                        <td class="p-4 text-sm text-slate-500">{{ o.created_at.strftime("%d/%m/%Y %H:%M") }}</td>
                        <td class="p-4 text-right">
                            <button onclick="openDataModal('{{ o.category_name | e }}', '{{ o.data | replace('\n', '<br>') }}')" class="text-blue-400 hover:text-blue-300 text-sm">ดูข้อมูล</button>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="4" class="p-8 text-center text-slate-500">ยังไม่มีประวัติการสั่งซื้อ</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="glass rounded-2xl shadow-xl border border-slate-700 overflow-hidden">
        <div class="p-6 border-b border-slate-700 flex items-center gap-3">
            <div class="bg-yellow-600 p-2 rounded-lg text-white"><i class="fa-solid fa-wallet"></i></div>
            <h2 class="text-xl font-bold text-white">ประวัติการเติมเงิน</h2>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full text-left text-slate-300">
                <thead class="bg-slate-900/50 text-slate-400 uppercase text-xs tracking-wider">
                    <tr>
                        <th class="p-4 font-medium">จำนวนเงิน</th>
                        <th class="p-4 font-medium">วิธี</th>
                        <th class="p-4 font-medium">สถานะ</th>
                        <th class="p-4 font-medium text-right">วันที่-เวลา</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-700/50">
                    {% for t in topups %}
                    <tr class="hover:bg-slate-700/50 transition">
                        <td class="p-4 text-yellow-400 font-mono font-bold">฿{{ "{:.2f}".format(t.amount) }}</td>
                        <td class="p-4 text-sm capitalize">
                            {% if t.method == 'truemoney_gift' %}
                                อั่งเปา
                            {% else %}
                                {{ t.method }}
                            {% endif %}
                        </td>
                        <td class="p-4">
                            {% if t.status == 'success' %}
                                <span class="inline-flex items-center text-green-400 text-sm font-bold">
                                    <span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span> สำเร็จ
                                </span>
                            {% elif t.status == 'pending' %}
                                <span class="inline-flex items-center text-yellow-400 text-sm font-bold">
                                    <span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span> รอตรวจสอบ
                                </span>
                            {% else %}
                                <span class="inline-flex items-center text-red-400 text-sm font-bold">
                                    <span class="w-2 h-2 bg-red-500 rounded-full mr-2"></span> ล้มเหลว
                                </span>
                            {% endif %}
                        </td>
                        <td class="p-4 text-right text-sm text-slate-500">{{ t.created_at.strftime("%d/%m/%Y %H:%M") }}</td>
                    </tr>
                    {% else %}
                    <tr><td colspan="4" class="p-8 text-center text-slate-500">ยังไม่มีประวัติการเติมเงิน</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="data-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="glass p-8 rounded-2xl shadow-2xl w-full max-w-lg transform translate-y-5 transition-transform duration-300">
        <h3 id="modal-data-title" class="text-2xl font-bold text-white mb-4 border-b border-slate-700 pb-2"></h3>
        <div class="bg-slate-900/50 p-4 rounded-lg h-64 overflow-y-auto drawer-scroll mb-4">
            <pre id="modal-data-content" class="text-sm text-green-400 whitespace-pre-wrap"></pre>
        </div>
        
        <div class="flex gap-3">
            <button onclick="copyData()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-bold">คัดลอกทั้งหมด</button>
            <button onclick="closeDataModal()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-lg font-bold">ปิด</button>
        </div>
    </div>
</div>

<script>
let currentData = "";

function openDataModal(title, data) {
    document.getElementById('modal-data-title').innerText = 'ข้อมูลสินค้า: ' + title;
    // ต้องเปลี่ยน <br> กลับเป็น \n ก่อนเก็บ
    currentData = data.replace(/<br>/g, '\n'); 
    document.getElementById('modal-data-content').innerHTML = data; // ใช้ innerHTML เพราะมี <br>
    
    const modal = document.getElementById('data-modal');
    modal.classList.remove('opacity-0', 'pointer-events-none');
    modal.querySelector('.w-full').classList.remove('translate-y-5');
}

function closeDataModal() {
    const modal = document.getElementById('data-modal');
    modal.classList.add('opacity-0', 'pointer-events-none');
    modal.querySelector('.w-full').classList.add('translate-y-5');
}

function copyData() {
    navigator.clipboard.writeText(currentData).then(() => {
        alert('คัดลอกข้อมูลสินค้าเรียบร้อยแล้ว');
        closeDataModal();
    }, (err) => {
        console.error('Could not copy text: ', err);
        alert('ไม่สามารถคัดลอกได้');
    });
}
</script>
{% endblock %}